generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// SQLite doesn't support enums, using String instead
// enum Role {
//   ADMIN
//   MANAGER
//   AGENT
//   VIEWER
// }

// enum IncidentSeverity {
//   LOW
//   MEDIUM
//   HIGH
//   CRITICAL
// }

// enum IncidentStatus {
//   OPEN
//   IN_PROGRESS
//   RESOLVED
//   CLOSED
// }

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         String    @default("VIEWER")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  refreshTokens RefreshToken[]
  reportedIncidents Incident[] @relation("Reporter")
  assignedIncidents Incident[] @relation("Assignee")
  comments      Comment[]
  auditLogs     AuditLog[]

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model Incident {
  id          String           @id @default(uuid())
  title       String
  description String
  severity    String
  status      String   @default("OPEN")
  assigneeId  String?          @map("assignee_id")
  reporterId  String           @map("reporter_id")
  dueAt       DateTime?        @map("due_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  assignee User?  @relation("Assignee", fields: [assigneeId], references: [id])
  reporter User   @relation("Reporter", fields: [reporterId], references: [id])
  comments Comment[]

  @@index([status])
  @@index([severity])
  @@index([assigneeId])
  @@index([reporterId])
  @@index([createdAt])
  @@map("incidents")
}

model Comment {
  id         String   @id @default(uuid())
  incidentId String   @map("incident_id")
  authorId   String   @map("author_id")
  text       String
  createdAt  DateTime @default(now()) @map("created_at")

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  author   User     @relation(fields: [authorId], references: [id])

  @@index([incidentId])
  @@index([createdAt])
  @@map("comments")
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String   @map("actor_id")
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String
    diffJson   String?  @map("diff_json") // JSON stored as text in PostgreSQL
  createdAt  DateTime @default(now()) @map("created_at")

  actor User @relation(fields: [actorId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
