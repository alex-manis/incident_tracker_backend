# Backend Code Review Report

## –û–±–∑–æ—Ä
–ü—Ä–æ–≤–µ–¥–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ backend –∫–æ–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ Incident Tracker. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–µ—à–µ–º, cookies, refresh —Ç–æ–∫–µ–Ω–∞–º–∏, –∞ —Ç–∞–∫–∂–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

–°–ª–µ–¥—É—é—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

1. ‚úÖ **Cookie path** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ `/` –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–∞ –≤—Å–µ—Ö –ø—É—Ç—è—Ö
2. ‚úÖ **–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ refresh token** - –∑–∞–º–µ–Ω–µ–Ω–æ bcrypt –Ω–∞ SHA-256 –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
3. ‚úÖ **Race condition –≤ refresh** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition
4. ‚úÖ **retryAfter –≤ rate limiter** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
5. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ toUserPublic** - —Å–æ–∑–¥–∞–Ω –æ–±—â–∏–π –º–æ–¥—É–ª—å `lib/mappers.ts`
6. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
7. ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Prisma –æ—à–∏–±–æ–∫ –∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
8. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è auth, incidents –∏ comments –æ–ø–µ—Ä–∞—Ü–∏–π
9. ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏** - —É–±—Ä–∞–Ω—ã –≤—Å–µ `any`, —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è Prisma —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å Cookie Path**
**–§–∞–π–ª:** `src/config.ts:24`

**–ü—Ä–æ–±–ª–µ–º–∞:** Cookie path —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ `/api/auth/refresh`, —á—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å cookie —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞.

```typescript
path: "/api/auth/refresh",  // ‚ùå Cookie –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø—É—Ç–∏
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Cookie –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å refresh —Ç–æ–∫–µ–Ω–æ–º –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- –ù–∞—Ä—É—à–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è httpOnly cookies

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
path: "/",  // ‚úÖ Cookie –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤—Å–µ—Ö –ø—É—Ç–µ–π
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Refresh Token**
**–§–∞–π–ª:** `src/repositories/refresh-token.repository.ts:11`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `hashPassword` (bcrypt) –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è refresh —Ç–æ–∫–µ–Ω–æ–≤. Bcrypt –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø–∞—Ä–æ–ª–µ–π –∏ —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤.

```typescript
const tokenHash = await hashPassword(data.token);  // ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–æ –∏ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–æ–≤
- –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SHA-256 –∏–ª–∏ –¥—Ä—É–≥–æ–π –±—ã—Å—Ç—Ä—ã–π —Ö–µ—à:
```typescript
import crypto from 'crypto';

function hashToken(token: string): string {
  return crypto.createHash('sha256').update(token).digest('hex');
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

### 3. **Race Condition –≤ Refresh Token Rotation**
**–§–∞–π–ª:** `src/services/auth.service.ts:100-108`

**–ü—Ä–æ–±–ª–µ–º–∞:** –•–æ—Ç—è –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–∏ race condition, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ –∏–¥–µ–∞–ª—å–Ω–∞. –ï—Å–ª–∏ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏–¥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –æ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º, –æ–±–∞ –º–æ–≥—É—Ç –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```typescript
// Create new token first, then revoke old one
await refreshTokenRepo.create({...});
await refreshTokenRepo.revokeToken(storedToken.id);
```

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:
```typescript
await prisma.$transaction(async (tx) => {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –µ—â–µ –Ω–µ –æ—Ç–æ–∑–≤–∞–Ω
  const token = await tx.refreshToken.findUnique({
    where: { id: storedToken.id },
  });
  
  if (!token || token.revokedAt) {
    throw new Error('Token already revoked');
  }
  
  // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
  await tx.refreshToken.create({...});
  
  // –û—Ç–æ–∑–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π
  await tx.refreshToken.update({
    where: { id: storedToken.id },
    data: { revokedAt: new Date() },
  });
});
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

### 4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ retryAfter –≤ Rate Limiter**
**–§–∞–π–ª:** `src/middleware/rate-limit.ts:19`

**–ü—Ä–æ–±–ª–µ–º–∞:** `retryAfter` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 15 –º–∏–Ω—É—Ç (900 —Å–µ–∫—É–Ω–¥), –Ω–æ `windowMs` –≤—Å–µ–≥–æ 1 –º–∏–Ω—É—Ç–∞.

```typescript
retryAfter: Math.ceil(15 * 60),  // ‚ùå 900 —Å–µ–∫—É–Ω–¥, –Ω–æ windowMs = 60000ms
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
retryAfter: Math.ceil(60),  // ‚úÖ 60 —Å–µ–∫—É–Ω–¥ = 1 –º–∏–Ω—É—Ç–∞
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

## üü° –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–æ–º –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

### 5. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ toUserPublic**
**–§–∞–π–ª—ã:** 
- `src/services/auth.service.ts:11-21`
- `src/services/user.service.ts:5-15`

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π –º–æ–¥—É–ª—å –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞:
```typescript
// src/lib/mappers.ts
export function toUserPublic(user: User): UserPublic {
  return {
    id: user.id,
    name: user.name,
    email: user.email,
    role: user.role as Role,
    isActive: user.isActive,
    createdAt: user.createdAt,
    updatedAt: user.updatedAt,
  };
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

### 6. **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ req.user –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö**
**–§–∞–π–ª—ã:**
- `src/controllers/auth.controller.ts:61`
- `src/controllers/incident.controller.ts:28,39`
- `src/controllers/comment.controller.ts:16`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `if (!req.user)` –∏–∑–±—ã—Ç–æ—á–Ω–∞, —Ç–∞–∫ –∫–∞–∫ `authMiddleware` —É–∂–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ `req.user`.

**–†–µ—à–µ–Ω–∏–µ:**
–£–¥–∞–ª–∏—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TypeScript type guards:
```typescript
// –í middleware/auth.ts
export interface AuthRequest extends Request {
  user: TokenPayload;  // ‚úÖ –£–±—Ä–∞—Ç—å optional, —Ç–∞–∫ –∫–∞–∫ middleware –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π

---

### 7. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ `any`**
**–§–∞–π–ª—ã:**
- `src/services/incident.service.ts:14,56,80`
- `src/services/comment.service.ts:8,31,64`
- `src/middleware/validate.ts:18,29`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any` —Å–Ω–∏–∂–∞–µ—Ç —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:**
–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã:
```typescript
// –í–º–µ—Å—Ç–æ any –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã Prisma
type IncidentWithIncludes = Incident & {
  assignee: User | null;
  reporter: User;
};
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

### 8. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è**
**–§–∞–π–ª:** `src/services/comment.service.ts:46`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
async create(incidentId: string, data: CreateCommentRequest, authorId: string) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
  const incident = await prisma.incident.findUnique({
    where: { id: incidentId },
  });
  
  if (!incident) {
    throw new Error('Incident not found');
  }
  
  // –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  ...
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

### 9. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î –≤ CommentService**
**–§–∞–π–ª:** `src/services/comment.service.ts:60`

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞, —Ö–æ—Ç—è –æ–Ω —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–≤–µ—Å—Ç–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `include` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç—å –∞–≤—Ç–æ—Ä–∞ –∏–∑ `req.user`:
```typescript
const comment = await commentRepo.create({
  incidentId,
  authorId,
  text: data.text,
}, {
  include: { author: true }  // –ï—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
});
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π

---

### 10. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∫ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é**
**–§–∞–π–ª:** `src/controllers/auth.controller.ts:60`

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `Cache-Control`, –Ω–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cache headers:
```typescript
// src/middleware/cache.ts
export function noCache(req: Request, res: Response, next: NextFunction) {
  res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
  res.setHeader('Pragma', 'no-cache');
  res.setHeader('Expires', '0');
  next();
}
```

–ò–ª–∏ –¥–ª—è –∫–µ—à–∏—Ä—É–µ–º—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:
```typescript
export function cacheFor(seconds: number) {
  return (req: Request, res: Response, next: NextFunction) => {
    res.setHeader('Cache-Control', `public, max-age=${seconds}`);
    next();
  };
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

### 11. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤**
**–§–∞–π–ª—ã:** –í—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–∞–∂–¥–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞.

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å dependency injection –∏–ª–∏ singleton pattern:
```typescript
// src/services/index.ts
export const authService = new AuthService();
export const incidentService = new IncidentService();
// ...

// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
import { authService } from '../services/index.js';
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π

---

### 12. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ UUID –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö**
**–§–∞–π–ª—ã:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ routes

**–ü—Ä–æ–±–ª–µ–º–∞:** UUID –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö, –Ω–µ –≤–µ–∑–¥–µ.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ UUID:
```typescript
export function validateUuid(paramName: string) {
  return validateParams(z.object({
    [paramName]: z.string().uuid(),
  }));
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π

---

## üü¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è

### 13. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î**
**–§–∞–π–ª:** `src/repositories/refresh-token.repository.ts:21-40`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ–∫–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞—Ç–µ–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤ —Ü–∏–∫–ª–µ.

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –≤ schema.prisma
model RefreshToken {
  ...
  @@index([userId, revokedAt, expiresAt])
}

// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫
async findByToken(userId: string, token: string): Promise<RefreshToken | null> {
  const tokenHash = hashToken(token);
  
  // –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –ø–æ —Ö–µ—à—É (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ tokenHash)
  return prisma.refreshToken.findFirst({
    where: {
      userId,
      tokenHash,
      revokedAt: null,
      expiresAt: { gt: new Date() },
    },
  });
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

### 14. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ Prisma Schema**
**–§–∞–π–ª:** `prisma/schema.prisma`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π:
- `RefreshToken.userId`
- `RefreshToken.expiresAt`
- `Incident.status`, `Incident.severity`
- `Comment.incidentId`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

### 15. **–£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `src/middleware/error-handler.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
```typescript
export function errorHandler(err: Error, req: Request, res: Response, next: NextFunction): void {
  logger.error({ err, path: req.path, method: req.method }, 'Request error');

  if (err instanceof ZodError) {
    res.status(400).json({
      error: 'Validation error',
      details: err.errors,
    });
    return;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Prisma –æ—à–∏–±–æ–∫
  if (err.name === 'PrismaClientKnownRequestError') {
    if (err.code === 'P2002') {
      res.status(409).json({ error: 'Duplicate entry' });
      return;
    }
    if (err.code === 'P2025') {
      res.status(404).json({ error: 'Record not found' });
      return;
    }
  }

  if (err.name === 'UnauthorizedError' || err.message === 'Unauthorized') {
    res.status(401).json({ error: 'Unauthorized' });
    return;
  }

  // –î–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤
  if (err.message === 'Invalid credentials' || err.message === 'User not found') {
    res.status(401).json({ error: err.message });
    return;
  }

  if (err.message === 'Forbidden') {
    res.status(403).json({ error: 'Forbidden' });
    return;
  }

  res.status(500).json({
    error: 'Internal server error',
    message: process.env.NODE_ENV === 'development' ? err.message : undefined,
  });
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

### 16. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è:
- –£—Å–ø–µ—à–Ω—ã—Ö –∏ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ ‚úÖ
- Refresh token –æ–ø–µ—Ä–∞—Ü–∏–π ‚úÖ
- –°–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ ‚úÖ
- –û—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–æ–≤ ‚úÖ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `auth.service.ts` –¥–ª—è login, refresh, logout
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `incident.service.ts` –¥–ª—è create –∏ update
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `comment.service.ts` –¥–ª—è create

---

### 17. **–£–ª—É—á—à–µ–Ω–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª—ã:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–±—Ä–∞—Ç—å –≤—Å–µ `as any` ‚úÖ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã Prisma ‚úÖ
- –°–æ–∑–¥–∞—Ç—å –æ–±—â–∏–µ —Ç–∏–ø—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤ ‚úÖ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `lib/types.ts` —Å —Ç–∏–ø–∞–º–∏ `IncidentWithRelations`, `CommentWithAuthor`, `AuditLogWithActor`
- –£–±—Ä–∞–Ω—ã –≤—Å–µ `any` –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –£–ª—É—á—à–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤ `validate.ts` –∏ `auth.controller.ts`

---

## üìã –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ–∞–π–ª—ã

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è. –ù–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ

1. ‚úÖ –ß–µ—Ç–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Routes ‚Üí Controllers ‚Üí Services ‚Üí Repositories)
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TypeScript
3. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å Zod
4. ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
5. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å pino
6. ‚úÖ Rate limiting –¥–ª—è auth —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
7. ‚úÖ Refresh token rotation
8. ‚úÖ Audit logging
9. ‚úÖ Health check –∏ metrics —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–Ω–æ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
1. Cookie path (–ø—Ä–æ–±–ª–µ–º–∞ #1)
2. –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ refresh token (–ø—Ä–æ–±–ª–µ–º–∞ #2)
3. Race condition –≤ refresh (–ø—Ä–æ–±–ª–µ–º–∞ #3)

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):
4. RetryAfter –≤ rate limiter (–ø—Ä–æ–±–ª–µ–º–∞ #4)
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ (–ø—Ä–æ–±–ª–µ–º–∞ #8)
6. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (–ø—Ä–æ–±–ª–µ–º–∞ #15)

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
7. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ toUserPublic (–ø—Ä–æ–±–ª–µ–º–∞ #5)
8. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ any (–ø—Ä–æ–±–ª–µ–º–∞ #7)
9. –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é (–ø—Ä–æ–±–ª–µ–º–∞ #10)
10. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (–ø—Ä–æ–±–ª–µ–º–∞ #13)
11. –ò–Ω–¥–µ–∫—Å—ã –≤ Prisma (–ø—Ä–æ–±–ª–µ–º–∞ #14)

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
12. –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ req.user (–ø—Ä–æ–±–ª–µ–º–∞ #6)
13. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î –≤ CommentService (–ø—Ä–æ–±–ª–µ–º–∞ #9)
14. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ (–ø—Ä–æ–±–ª–µ–º–∞ #11)
15. –í–∞–ª–∏–¥–∞—Ü–∏—è UUID (–ø—Ä–æ–±–ª–µ–º–∞ #12)
16. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–æ–±–ª–µ–º–∞ #16)
17. –¢–∏–ø–∏–∑–∞—Ü–∏—è (–ø—Ä–æ–±–ª–µ–º–∞ #17)

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é

1. **–î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (auth, refresh token)
2. **–î–æ–±–∞–≤–∏—Ç—å integration —Ç–µ—Å—Ç—ã** –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
3. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å API** (Swagger/OpenAPI)
5. **–î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –ë–î
6. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis** –¥–ª—è rate limiting –≤ production
7. **–î–æ–±–∞–≤–∏—Ç—å request ID** –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
8. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ connection pooling** –¥–ª—è Prisma

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ö–æ–¥ –≤ —Ü–µ–ª–æ–º —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–ª–µ–¥—É–µ—Ç –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å:
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π cookies (–∫—Ä–∏—Ç–∏—á–Ω–æ)
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π —Ä–∞–±–æ—Ç—ã —Å refresh tokens (–∫—Ä–∏—Ç–∏—á–Ω–æ)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–¥–∞ (—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é (—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –∫–æ–¥ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.
